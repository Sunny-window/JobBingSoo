<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"> <!--타임리프-->

<head>
    <meta charset="UTF-8"><!--한국어-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"><!--반응형-->
    <title>공고 관리 페이지</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script><!--jquery 의존성 주입-->
</head>

<body>
    <header>
        <th:block th:insert="~{/sub/header.html}"></th:block>
    </header>
    <section>
        <h1>공고 관리 페이지</h1>
        <hr>
        <div class="content"></div>
        <button onclick="posting_form()">공고작성</button>
    </section>
    <footer>
        <th:block th:insert="~{/sub/footer.html}"></th:block>
    </footer>
    <script>
        function posting_form() {
            window.location.href = "/ice/employ_notice_form";
        }

        document.addEventListener('DOMContentLoaded', function () {
            // 페이지가 로드될 때 실행되는 함수
            ajax1();
        });

        function ajax1() {
            fetch("http://localhost:9001/ice/my-postings?cid=홍길동", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            })
                // 서버에서 데이터를 가져오는 fetch 요청
                .then(response => response.json())
                // 응답을 JSON 형식으로 변환
                .then(data => {
                    // JSON 데이터를 받아와서 처리하는 코드
                    console.log('Received data:', data);
                    // 데이터를 콘솔에 출력

                    let contentDiv = document.querySelector('.content');
                    // HTML에서 클래스가 'content'인 요소를 찾음
                    contentDiv.innerHTML = ''; // 내용을 초기화 (기존에 있던 내용 삭제)

                    data.forEach(posting => {
                        // 받아온 데이터 각각에 대해 반복문 실행
                        let div = document.createElement('div');
                        // 새로운 div 요소를 생성

                        let button1 = document.createElement('button');
                        let button2 = document.createElement('button');
                        let button3 = document.createElement('button');
                        // 각각의 버튼 요소를 생성

                        // 버튼에 텍스트 내용 설정
                        button1.textContent = '지원자 보기';
                        button2.textContent = '공고 수정';
                        button3.textContent = '공고 삭제';

                        // div 요소에 텍스트 내용 추가
                        div.textContent = `제목: ${posting.title}, 마감일: ${posting.deadline}, 주소: ${posting.address}, 회사명: ${posting.company_name}`;
                        // div 요소에 버튼 요소들을 자식 요소로 추가
                        div.appendChild(button1);
                        div.appendChild(button2);
                        div.appendChild(button3);

                        // contentDiv에 div 요소를 추가
                        contentDiv.appendChild(div);

                        // 각 버튼에 클릭 이벤트 리스너 추가
                        list(button1, posting.post_code);
                        update(button2, posting.post_code);
                        delete1(button3, posting.post_code);
                    });
                })
                .catch(error => console.error('데이터 가져오기나 파싱 중 오류 발생:', error));
            // 오류 발생 시 콘솔에 오류 메시지 출력
        }

        function list(button1, postCode) {
            button1.addEventListener('click', () => {
                // 클릭 시 실행될 코드
                window.location.href = '/ice/red_bean_list?postCode=' + postCode;
            });
        }

        function update(button2, postCode) {
            button2.addEventListener('click', () => {
                // 클릭 시 실행될 코드
                window.location.href = "/ice/employ_notice_form?postCode = " + postCode;
            });
        }

        function delete1(button3, postCode) {
            button3.addEventListener('click', () => {
                // 클릭 시 실행될 코드
                // 선택적으로 서버로 삭제 요청을 보낼 수 있음
                fetch(`http://localhost:9001/ice/posting/${postCode}`, {
                    method: "DELETE"
                })
                .then(response=>{
                    if(response.ok){
                        ajax1();
                    }
                })
                .catch(error => console.error('Error deleting posting:', error));
            });

        }



    </script>
</body>

</html>